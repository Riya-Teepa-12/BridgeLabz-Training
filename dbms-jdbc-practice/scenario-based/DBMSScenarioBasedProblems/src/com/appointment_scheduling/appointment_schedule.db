-- =====================================================
-- APPOINTMENT SCHEDULING SYSTEM (UC-3)
-- =====================================================

-- Step 1: Create Database
create database  Appointment_Scheduling;

-- Step 2: Use Database
use  Appointment_Scheduling;

-- =====================================================
-- Step 3: Create Patients Table
-- =====================================================
CREATE TABLE patients (
    patient_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    age INT,
    contact VARCHAR(15)
);

-- =====================================================
-- Step 4: Create Doctors Table
-- =====================================================
CREATE TABLE doctors (
    doctor_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    specialization VARCHAR(100)
);

-- =====================================================
-- Step 5: Create Appointments Table
-- =====================================================
CREATE TABLE appointments (
    appointment_id INT PRIMARY KEY AUTO_INCREMENT,
    patient_id INT,
    doctor_id INT,
    appointment_date DATE,
    appointment_time TIME,
    status VARCHAR(20),
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id)
);

-- =====================================================
-- Step 6: Create Appointment Audit Table
-- =====================================================
CREATE TABLE appointment_audit (
    audit_id INT PRIMARY KEY AUTO_INCREMENT,
    appointment_id INT,
    action VARCHAR(50),
    action_date DATETIME
);

-- =====================================================
-- Step 7: Insert Data into Patients Table
-- =====================================================
INSERT INTO patients (name, age, contact) VALUES
('Riya Teepa', 22, '9876543210'),
('Aman Verma', 30, '9123456789');

-- =====================================================
-- Step 8: Insert Data into Doctors Table
-- =====================================================
INSERT INTO doctors (name, specialization) VALUES
('Dr. Sharma', 'Cardiology'),
('Dr. Mehta', 'Orthopedics');

-- =====================================================
-- UC-3.1: Check Doctor Availability Before Booking
-- =====================================================
SELECT COUNT(*)
FROM appointments
WHERE doctor_id = 1
  AND appointment_date = '2026-02-10'
  AND appointment_time = '10:00:00'
  AND status = 'SCHEDULED';

-- =====================================================
-- UC-3.1: Book New Appointment
-- =====================================================
INSERT INTO appointments
(patient_id, doctor_id, appointment_date, appointment_time, status)
VALUES (1, 1, '2026-02-10', '10:00:00', 'SCHEDULED');

-- =====================================================
-- UC-3.2: Check Doctor Availability (Slot-wise)
-- =====================================================
SELECT appointment_time,
       COUNT(*) AS booked_slots
FROM appointments
WHERE doctor_id = 1
  AND appointment_date = '2026-02-10'
  AND status = 'SCHEDULED'
GROUP BY appointment_time;

-- =====================================================
-- UC-3.3: Cancel Appointment (Transaction Start)
-- =====================================================
START TRANSACTION;

UPDATE appointments
SET status = 'CANCELLED'
WHERE appointment_id = 1;

INSERT INTO appointment_audit
(appointment_id, action, action_date)
VALUES (1, 'CANCELLED', NOW());

COMMIT;

-- =====================================================
-- UC-3.4: Reschedule Appointment (Transaction Start)
-- =====================================================
START TRANSACTION;

SELECT COUNT(*)
FROM appointments
WHERE doctor_id = 2
  AND appointment_date = '2026-02-11'
  AND appointment_time = '11:00:00'
  AND status = 'SCHEDULED';

UPDATE appointments
SET doctor_id = 2,
    appointment_date = '2026-02-11',
    appointment_time = '11:00:00'
WHERE appointment_id = 1;

COMMIT;

-- =====================================================
-- UC-3.5: View Appointment Schedule for 2026-02-10
-- =====================================================
SELECT
    a.appointment_time,
    p.name AS patient_name,
    d.name AS doctor_name,
    d.specialization,
    a.status
FROM appointments a
JOIN patients p ON a.patient_id = p.patient_id
JOIN doctors d ON a.doctor_id = d.doctor_id
WHERE a.appointment_date = '2026-02-10'
ORDER BY a.appointment_time;

-- =====================================================
-- View Doctors Table
-- =====================================================
select * from doctors;

-- =====================================================
-- View Patients Table
-- =====================================================
select * from patients;

-- =====================================================
-- View Appointments Table
-- =====================================================
select * from appointments;

-- =====================================================
-- View Appointment Audit Logs
-- =====================================================
select * from appointment_audit;

-- =====================================================
-- Insert Another Appointment for Demonstration
-- =====================================================
INSERT INTO appointments
(patient_id, doctor_id, appointment_date, appointment_time, status)
VALUES (1, 1, '2026-02-10', '10:00:00', 'SCHEDULED');

-- =====================================================
-- View Schedule for 2026-02-11
-- =====================================================
SELECT
    a.appointment_time,
    p.name AS patient_name,
    d.name AS doctor_name,
    d.specialization,
    a.status
FROM appointments a
JOIN patients p ON a.patient_id = p.patient_id
JOIN doctors d ON a.doctor_id = d.doctor_id
WHERE a.appointment_date = '2026-02-11'
ORDER BY a.appointment_time;

-- =====================================================
-- View Scheduled Appointment Using JOIN
-- =====================================================
SELECT
    a.appointment_time,
    p.name AS patient_name,
    d.name AS doctor_name,
    d.specialization,
    a.status
FROM appointments a
JOIN patients p ON a.patient_id = p.patient_id
JOIN doctors d ON a.doctor_id = d.doctor_id
WHERE a.appointment_date = '2026-02-10'
  AND a.appointment_time = '10:00:00'
  AND a.status = 'SCHEDULED';
+------------------+--------------+-------------+----------------+-----------+
| appointment_time | patient_name | doctor_name | specialization | status    |
+------------------+--------------+-------------+----------------+-----------+
| 10:00:00         | Riya Teepa   | Dr. Sharma  | Cardiology     | SCHEDULED |
+------------------+--------------+-------------+----------------+-----------+
1 row in set (0.00 sec)

mysql> select * from appointment_audit;
+----------+----------------+-----------+---------------------+
| audit_id | appointment_id | action    | action_date         |
+----------+----------------+-----------+---------------------+
|        1 |              1 | CANCELLED | 2026-02-09 12:19:09 |
+----------+----------------+-----------+---------------------+
1 row in set (0.00 sec)